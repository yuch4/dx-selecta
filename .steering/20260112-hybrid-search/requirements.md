# 要求内容: ハイブリッド検索（BM25 + pgvector）

## 概要

診断入力を元に、BM25全文検索 + pgvectorベクトル検索を組み合わせたハイブリッド検索を実装し、より精度の高い製品推薦を実現する。

## 背景

現在の検索機能は fact_type ベースのフィルタリングとシンプルなスコア計算のみで、PRDで要求されている「BM25 + ベクトル検索のハイブリッドで候補を抽出」が未実装。これにより、製品説明文やドキュメントの内容を活用した意味的な検索ができていない。

## PRD該当箇所（引用）

> **2. 検索・推薦（ハイブリッド検索）**
>
> **受け入れ条件**:
> - [ ] Mustフィルタ（facts/price/integrations）で候補を絞り込める
> - [ ] BM25 + ベクトル検索のハイブリッドで候補を抽出できる
> - [ ] 重み付きスコアでランキングされた上位3〜5件が表示される
> - [ ] 各候補にExplain（根拠URL/抜粋/最終確認日/懸念点/質問リスト）が付与される
> - [ ] "要確認"項目がある場合は明示される
> - [ ] 検索結果表示まで2秒以内（100件DBの場合）

## 実装対象の機能

### 1. BM25全文検索
- PostgreSQL の ts_rank + to_tsvector を使用
- solution_chunks テーブルの content カラムを対象
- 日本語トークナイズ対応（pgroonga or pg_bigm が使えない場合はシンプル分割）

### 2. ベクトル検索
- pgvector 拡張を使用
- OpenAI Embeddings API で診断入力のクエリをベクトル化
- solution_chunks.embedding との類似度検索

### 3. スコア統合アルゴリズム
- BM25スコア（40%）+ ベクトル類似度（60%）で関連度スコアを算出
- Must条件マッチ率も加味して最終スコア決定
- 設計書記載のアルゴリズムに準拠

### 4. solution_chunks テーブル・インデックス整備
- テーブル作成（存在しない場合）
- GINインデックス（BM25用）
- IVFFlatインデックス（ベクトル用）

## 受け入れ条件

### ハイブリッド検索
- [x] Mustフィルタ（SSO/監査ログ）で候補を絞り込める（既存）
- [ ] BM25全文検索が solution_chunks.content を対象に動作する
- [ ] ベクトル検索が solution_chunks.embedding を対象に動作する
- [ ] BM25スコアとベクトルスコアを統合したランキングが機能する
- [ ] 検索結果に matchedChunks（関連テキスト抜粋）が含まれる

### パフォーマンス
- [ ] 検索結果表示が2秒以内（100件DB）

### コード品質
- [ ] lint / typecheck / build がエラーなく通る

## 成功指標

- ハイブリッド検索によりカテゴリ外の関連製品も推薦される
- 検索結果の explain に具体的なテキスト抜粋が含まれる

## スコープ外

以下はこのフェーズでは実装しません:

- OpenAI GPT による稟議テキスト生成（別機能）
- 日本語形態素解析の高度化（MeCab/Sudachi連携）
- Read Replicaによる検索最適化
- バッチEmbedding生成（今回は検索時オンデマンド生成）

## 参照ドキュメント

- `docs/product-requirements.md` - PRD 2. 検索・推薦
- `docs/functional-design.md` - 3.3 SearchService, 4.2 検索・推薦フロー
- `docs/architecture.md` - 4.4 インデックス設計
