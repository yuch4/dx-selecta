# Architecture Design Reference

アーキテクチャ設計書作成の詳細ガイド。

## 目次
1. [目的](#目的)
2. [技術選定の原則](#技術選定の原則)
3. [セクション別ガイド](#セクション別ガイド)
4. [レビューチェックリスト](#レビューチェックリスト)
5. [よくある問題と対策](#よくある問題と対策)

---

## 目的

機能設計の「どう実現するか」を「どの技術で・どう構成するか」に変換する。

**アーキテクチャ設計書が担う役割**:
- 技術選定の根拠を残す
- 非機能要件の実現方法を定義する
- 開発者が迷わない構成を示す
- 将来のスケールに備える

---

## 技術選定の原則

### 1. 選定理由を必ず書く

**悪い例**:
| 技術 | 用途 |
|------|------|
| React | フロントエンド |

**良い例**:
| 技術 | 用途 | 選定理由 |
|------|------|----------|
| React 19 | フロントエンド | Next.js標準、RSC対応、チーム習熟度高 |

### 2. 代替案を検討した形跡を残す

重要な選定では「なぜ他を選ばなかったか」も記録：

```
## DB選定
選定: Supabase (PostgreSQL)
代替検討:
- PlanetScale (MySQL): Supabaseの方がAuth/Storage統合で初期開発が速い
- Neon: Supabaseの方がエコシステムが成熟
```

### 3. 制約を考慮する

| 制約種別 | 例 |
|---------|-----|
| 予算 | 月額$50以下 → Supabase Free + Vercel Hobby |
| 期間 | 2週間でMVP → 学習コスト低い技術を優先 |
| チームスキル | TypeScript経験者のみ → TSベースに統一 |
| 既存資産 | 既にSupabaseプロジェクトあり → 継続利用 |

---

## セクション別ガイド

### 技術スタック
- **全項目にバージョン+選定理由**を書く
- カテゴリ分け: 言語 / FW / DB / インフラ / ツール
- LTSバージョンを優先

### システム構成図
- **Mermaid `graph TB`** で描く
- サブグラフでレイヤー/環境を分離
- 主要なデータフローを矢印で示す
- 外部サービスも含める

### レイヤー設計
- 責務を明確に（何をする/何をしない）
- **依存方向を一方向に保つ**（上→下のみ）
- 循環依存の禁止を明記

### データ戦略
| 項目 | 書くべきこと |
|------|-------------|
| 設計方針 | 正規化レベル、主キー戦略、削除戦略 |
| バックアップ | 頻度、保持期間、復旧手順 |
| キャッシュ | 対象、方式、TTL |
| マイグレーション | ツール、運用ルール |

### セキュリティ
| 領域 | 最低限書くこと |
|------|---------------|
| 認証 | 方式、セッション管理、トークン有効期限 |
| 認可 | アクセス制御方式（RLS/RBAC等） |
| 暗号化 | 通信時、保存時 |
| 入力検証 | バリデーション方式、対策 |
| 監査 | ログ保持期間、記録項目 |

### パフォーマンス
- **目標値を数値で定義**（PRDの非機能要件と連携）
- **測定方法を明記**（ツール名）
- 最適化施策を領域別に列挙

### スケーラビリティ
- **想定負荷を数値で示す**（現在→6ヶ月→1年）
- フェーズ別のスケール戦略
- ボトルネックになりうる箇所の特定

---

## レビューチェックリスト

### 技術選定
- [ ] すべての技術に選定理由がある
- [ ] バージョンが明記されている
- [ ] 重要な選定は代替案の検討が記録されている
- [ ] 制約（予算・期間・スキル）を考慮している

### 構成・レイヤー
- [ ] システム構成図がある
- [ ] レイヤー間の依存ルールが明確
- [ ] 循環依存の禁止が明記されている

### データ
- [ ] DB設計方針が定義されている
- [ ] バックアップ戦略がある
- [ ] 復旧手順が明記されている（または参照がある）

### セキュリティ
- [ ] 認証・認可方式が定義されている
- [ ] 暗号化（通信・保存）が考慮されている
- [ ] 入力検証方式が定義されている

### パフォーマンス
- [ ] 目標値が数値で定義されている
- [ ] PRDの非機能要件と整合している
- [ ] 測定方法が明記されている

### スケーラビリティ
- [ ] 想定負荷が数値で示されている
- [ ] スケール戦略がフェーズ別に定義されている

### 依存関係
- [ ] バージョン管理方針が定義されている
- [ ] 更新サイクルが決まっている

### テスト
- [ ] テスト種別と対象が定義されている
- [ ] カバレッジ目標がある
- [ ] CI/CD連携が定義されている

---

## よくある問題と対策

| 問題 | 原因 | 対策 |
|------|------|------|
| 選定理由がない | 「とりあえず」で選んだ | 必ず理由欄を埋める |
| 非機能要件が漏れる | 機能設計と混同 | PRDの非機能要件を1つずつ対応付け |
| スケールを考えていない | MVPだけ見ている | 6ヶ月後・1年後の想定を書く |
| セキュリティが後回し | 「後で考える」 | チェックリストで必須化 |
| 依存方向が曖昧 | 図だけで説明がない | 表形式で許可/禁止を明記 |
| バックアップ復旧が未定義 | 「壊れたら考える」 | 復旧手順を必須項目に |

---

## 非機能要件との対応表（テンプレート）

PRDの非機能要件がアーキテクチャでどう実現されるか追跡する：

| PRD非機能要件 | アーキ設計の対応箇所 | 実現方法 |
|--------------|-------------------|---------|
| ページ読み込み3秒以内 | 6.1 パフォーマンス目標 | RSC + CDN + 画像最適化 |
| 同時100ユーザー | 7.1 想定負荷 | Vercel Auto Scaling |
| データ損失ゼロ | 4.2 バックアップ戦略 | 日次バックアップ + PITR |
| OAuth認証 | 5.1 認証 | Supabase Auth |
